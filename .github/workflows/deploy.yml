name: Reusable Deploy Workflow

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment to deploy to (sandbox or production)'
      deploy_netlify:
        required: false
        type: boolean
        default: true
        description: 'Whether to deploy to Netlify'
      deploy_supabase:
        required: false
        type: boolean
        default: true
        description: 'Whether to deploy Supabase migrations'
    secrets:
      VITE_SUPABASE_URL:
        required: true
      VITE_SUPABASE_ANON_KEY:
        required: true
      SUPABASE_PROJECT_REF:
        required: true
      SUPABASE_ACCESS_TOKEN:
        required: true
      SUPABASE_DB_PASSWORD:
        required: true
      NETLIFY_AUTH_TOKEN:
        required: false
      NETLIFY_SITE_ID:
        required: false

jobs:
  deploy-supabase:
    name: Deploy Supabase - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    if: inputs.deploy_supabase
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: |
          supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}" --password "${{ secrets.SUPABASE_DB_PASSWORD }}"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Push database migrations
        run: |
          supabase db push --password "${{ secrets.SUPABASE_DB_PASSWORD }}"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy Edge Functions
        run: |
          if [ -d "supabase/functions" ]; then
            supabase functions deploy
          else
            echo "No Edge Functions to deploy"
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # Netlify deployment is commented out - using Netlify's direct Git integration instead
  # deploy-netlify:
  #   name: Deploy to Netlify - ${{ inputs.environment }}
  #   runs-on: ubuntu-latest
  #   needs: [deploy-supabase]
  #   if: inputs.deploy_netlify
  #   environment: ${{ inputs.environment }}
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version-file: '.nvmrc'
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Build application
  #       run: npm run build
  #       env:
  #         VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  #         VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
  #
  #     - name: Deploy to Netlify
  #       uses: nwtgck/actions-netlify@v3.0
  #       with:
  #         publish-dir: './dist'
  #         production-branch: ${{ inputs.environment == 'production' && 'main' || '' }}
  #         production-deploy: ${{ inputs.environment == 'production' }}
  #         deploy-message: "Deploy to ${{ inputs.environment }} from GitHub Actions"
  #         enable-pull-request-comment: false
  #         enable-commit-comment: true
  #         overwrites-pull-request-comment: true
  #         alias: ${{ inputs.environment == 'sandbox' && format('sandbox-{0}', github.sha) || '' }}
  #       env:
  #         NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
  #         NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
  #       timeout-minutes: 5